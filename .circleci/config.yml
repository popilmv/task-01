#slack-fail-post-step: &slack-fail-post-step
#  post-steps:
#    - slack/status:
#        fail_only: true
#orbs:
#  slack: circleci/slack@4.9.3
orbs:
  slack: circleci/slack@4.4.4

workflows:
  version: 2
  test_workflow:
    jobs:
     - test
     - notify
     - build:
          requires:
           - test
     - push:
          requires:
            - build
          filters:
            branches: 
              only: main, dev 
            tags: 
              only: '\d{1,2}\.\d{1,2}\.\d{1,2}'

jobs:
  test:
   docker:
    - image: docker:stable
    - image: go:stable
   steps:
    - checkout
    - run: gofmt -e main.go

  notify:
    docker: 
      - image: cimg/base:stable
    steps: 
      - slack/notify:
         event: fail

  build: 
     docker:
      - image: docker:stable
      - image: go:stable
     requires: 
      test
     steps: go build -o main main.go
  
  push:
    docker: 
      -image: docker:stable
    steps: 
      - checkout
      
